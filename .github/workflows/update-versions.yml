name: Update Version Badges

on:
  push:
    branches: [main]
    paths:
      - '**/*.plugin.js'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update version badges
        run: |
          KP_VERSION=$(grep -oP '@version \K[0-9.]+' KeywordPing/KeywordPing.plugin.js)
          IC_VERSION=$(grep -oP '@version \K[0-9.]+' Incognito/Incognito.plugin.js)
          TP_VERSION=$(grep -oP '@version \K[0-9.]+' TwitchPreview/TwitchPreview.plugin.js)
          PD_VERSION=$(grep -oP '@version \K[0-9.]+' PriorityDM/PriorityDM.plugin.js)
          STL_VERSION=$(grep -oP '@version \K[0-9.]+' ScrollToLatest/ScrollToLatest.plugin.js)
          HS_VERSION=$(grep -oP '@version \K[0-9.]+' HideSidebar/HideSidebar.plugin.js)

          sed -i "s|\[keywordping-version-badge\]: https://img.shields.io/badge/version-[0-9.]*-brightgreen|\[keywordping-version-badge\]: https://img.shields.io/badge/version-${KP_VERSION}-brightgreen|" README.md
          sed -i "s|\[incognito-version-badge\]: https://img.shields.io/badge/version-[0-9.]*-brightgreen|\[incognito-version-badge\]: https://img.shields.io/badge/version-${IC_VERSION}-brightgreen|" README.md
          sed -i "s|\[twitchpreview-version-badge\]: https://img.shields.io/badge/version-[0-9.]*-brightgreen|\[twitchpreview-version-badge\]: https://img.shields.io/badge/version-${TP_VERSION}-brightgreen|" README.md
          sed -i "s|\[prioritydm-version-badge\]: https://img.shields.io/badge/version-[0-9.]*-brightgreen|\[prioritydm-version-badge\]: https://img.shields.io/badge/version-${PD_VERSION}-brightgreen|" README.md
          sed -i "s|\[scrolltolatest-version-badge\]: https://img.shields.io/badge/version-[0-9.]*-brightgreen|\[scrolltolatest-version-badge\]: https://img.shields.io/badge/version-${STL_VERSION}-brightgreen|" README.md
          sed -i "s|\[hidesidebar-version-badge\]: https://img.shields.io/badge/version-[0-9.]*-brightgreen|\[hidesidebar-version-badge\]: https://img.shields.io/badge/version-${HS_VERSION}-brightgreen|" README.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --quiet README.md || (git add README.md && git commit -m "Update version badges" && git push)
